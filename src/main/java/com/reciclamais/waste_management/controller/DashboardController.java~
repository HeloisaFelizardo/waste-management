package com.reciclamais.waste_management.controller;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.reciclamais.waste_management.dto.TypeWasteDTO;
import com.reciclamais.waste_management.service.WasteService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;

import java.util.List;

@Controller
public class DashboardController {

    @Autowired
    private final WasteService wasteService;

    public DashboardController(WasteService wasteService) {
        this.wasteService = wasteService;
    }

    @GetMapping({"/", "/dashboard"})
    public String dashboard(Model model) throws JsonProcessingException {
        double totalWaste = wasteService.getTotalWaste();
        double wasteRecycled = wasteService.getWasteRecycled();
        double recyclingRate = wasteService.getRecyclingRate();
        List<TypeWasteDTO> typeWaste = wasteService.getWasteByType();
        ObjectMapper objectMapper = new ObjectMapper();
        String typeWasteJson = objectMapper.writeValueAsString(typeWaste);
        model.addAttribute("typeWaste", typeWasteJson);

        model.addAttribute("totalWaste", String.format("%.1f", totalWaste));
        model.addAttribute("wasteRecycled", String.format("%.1f", wasteRecycled));
        model.addAttribute("recyclingRate", String.format("%.1f", recyclingRate));
       // model.addAttribute("typeWaste", typeWaste);
        //model.addAttribute("rankingUsers", List.of()); // Empty list for now

        return "dashboard";
    }
} 